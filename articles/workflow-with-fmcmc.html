<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow with fmcmc • fmcmc</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Workflow with fmcmc">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-108627422-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108627422-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fmcmc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/benchmarks.html">Benchmarks</a>
    </li>
    <li>
      <a href="../articles/user-defined-kernels.html">User-defined kernels</a>
    </li>
    <li>
      <a href="../articles/workflow-with-fmcmc.html">Workflow with fmcmc</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USCbiostats/fmcmc">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Workflow with fmcmc</h1>
                        <h4 class="author">George G. Vega Yon</h4>
            
            <h4 class="date">April 19th, 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USCbiostats/fmcmc/blob/master/vignettes/workflow-with-fmcmc.Rmd"><code>vignettes/workflow-with-fmcmc.Rmd</code></a></small>
      <div class="hidden name"><code>workflow-with-fmcmc.Rmd</code></div>

    </div>

    
    
<div id="motivating-example" class="section level1">
<h1 class="hasAnchor">
<a href="#motivating-example" class="anchor"></a>Motivating example</h1>
<p>We start by loading the dataset that the <code>mcmc</code> package includes. We will use the <code>logit</code> data set to obtain a posterior distribution of the model parameters using the <code>MCMC</code> function.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fmcmc)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(logit, <span class="dt">package =</span> <span class="st">"mcmc"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(y <span class="op">~</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">+</span><span class="st"> </span>x3 <span class="op">+</span><span class="st"> </span>x4, <span class="dt">data =</span> logit, <span class="dt">family =</span> binomial, <span class="dt">x =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">beta.init &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span>(out))</a></code></pre></div>
<p>To be able to use the Metropolis-Hastings MCMC algorithm the function should be (in principle) the log unnormalized posterior. The following block of code, which was extracted from the <code>mcmc</code> package vignette “MCMC Package Example” creates the function that we will be using</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">lupost_factory &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="cf">function</span>(beta) {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">    eta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(x <span class="op">%*%</span><span class="st"> </span>beta)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    logp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(eta <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, eta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(eta)), <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="st"> </span>eta)))</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    logq &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(eta <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(eta)), <span class="op">-</span><span class="st"> </span>eta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="st"> </span>eta)))</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    logl &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(logp[y <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(logq[y <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(logl <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(beta<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span><span class="dv">8</span>)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">lupost &lt;-<span class="st"> </span><span class="kw">lupost_factory</span>(out<span class="op">$</span>x, out<span class="op">$</span>y)</a></code></pre></div>
<p>Let’s give it a first try. In this case we will use the beta estimates from the estimated GLM model as a starting point for the algorithm, and we will ask it to sample 1e4 points from the posterior distribution (<code>nsteps</code>).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># to get reproducible results</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="dt">initial =</span> beta.init,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="dt">fun     =</span> lupost,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  <span class="dt">nsteps  =</span> <span class="fl">1e3</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">)</a></code></pre></div>
<p>Since the resulting object is of class <code>mcmc</code> (from the <code>coda</code> R package), we can use all the functions included in <code>coda</code> for model diagnostics:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(coda)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/post-estimation-1.png" width="600" height="600"></p>
<p>So this chain has very poor mixing, so let’s try again by using a smaller scale for the normal kernel proposal moving it from 1 (the default value) to .2:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># to get reproducible results</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="dt">initial =</span> beta.init,</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="dt">fun     =</span> lupost,</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="dt">nsteps  =</span> <span class="fl">1e3</span>,</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="dt">kernel  =</span> <span class="kw"><a href="../reference/kernel_normal.html">kernel_normal</a></span>(<span class="dt">scale =</span> <span class="fl">.2</span>) </a>
<a class="sourceLine" id="cb5-8" data-line-number="8">)</a></code></pre></div>
<p>The <code>kernel_normal</code>, which is the default kernel in the <code>MCMC</code> function, returns an object of class <code>fmcmc_kernel</code>. In principle it consists on a list of two functions that are used by the <code>MCMC</code> routine: <code>proposal</code>, the proposal kernel function, and <code>logratio</code>, the function that returns the log of the Metropolis-Hastings ratio. We will talk more about <code>fmcmc_kernel</code> objects later. Now, let’s look at the first three variables of our model:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/unnamed-chunk-1-1.png" width="600" height="600"></p>
<p>Better. Now, ideally we should only be using observations from the stationary distribution. Let’s give it another try checking for convergence every 1,000 steps using the <code>convergence_geweke</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># to get reproducible results</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="dt">initial =</span> beta.init,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="dt">fun     =</span> lupost,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="dt">nsteps  =</span> <span class="fl">1e4</span>,</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="dt">kernel  =</span> <span class="kw"><a href="../reference/kernel_normal.html">kernel_normal</a></span>(<span class="dt">scale =</span> <span class="fl">.2</span>),</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="dt">conv_checker =</span> <span class="kw"><a href="../reference/convergence-checker.html">convergence_geweke</a></span>(<span class="dv">200</span>)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">)</a></code></pre></div>
<pre><code>## Convergence has been reached with 200 steps (200 final count of samples).</code></pre>
<p>A bit better. As announced by <code>MCMC</code>, the chain has reach a stationary state. With this in hand, we can now rerun the algorithm such that we start from the last couple of step of the chain, this time, without convergence monitoring as it is no longer necessary.</p>
<p>We will increase the number of steps (sample size), use 2 chains using parallel computing, and add some thinning to reduce autocorrelation:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># Now we change the seed so we get a different stream of</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co"># pseudo random numbers</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">112</span>) </a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">out_final &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="dt">initial   =</span> out,                       <span class="co"># Automagically takes the last 2 points</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="dt">fun       =</span> lupost, </a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="dt">nsteps    =</span> <span class="fl">5e4</span>,                       <span class="co"># Increasing the sample size</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  <span class="dt">kernel    =</span> <span class="kw"><a href="../reference/kernel_normal.html">kernel_normal</a></span>(<span class="dt">scale =</span> <span class="fl">.2</span>),</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  <span class="dt">thin      =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">  <span class="dt">nchains   =</span> 2L,                        <span class="co"># Running parallel chains</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="dt">multicore =</span> <span class="ot">TRUE</span>                       <span class="co"># in parallel.</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  )</a></code></pre></div>
<p>Observed that, instead of specifying what are the 2 starting points for each chain, we passed the <code>out</code> to the initial set of parameters. By default, if <code>initial</code> is of class <code>mcmc</code>, <code>MCMC</code> will take the last <code>nchains</code> points from the chain as starting point for the new sequence. If <code>initial</code> is of class <code>mcmc.list</code>, the number of chains in <code>initial</code> must match the <code>nchains</code> parameter. We now see that the output posterior distribution appears to be stationary</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out_final[, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/final-results-1.png" width="600" height="600"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(out_final[, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<pre><code>## 
## Iterations = 10:50000
## Thinning interval = 10 
## Number of chains = 2 
## Sample size per chain = 5000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##        Mean     SD Naive SE Time-series SE
## par1 0.6538 0.3037 0.003037       0.004982
## par2 0.8074 0.3730 0.003730       0.006752
## par3 1.1649 0.3644 0.003644       0.006688
## 
## 2. Quantiles for each variable:
## 
##         2.5%    25%    50%    75% 97.5%
## par1 0.08219 0.4435 0.6465 0.8529 1.273
## par2 0.10899 0.5489 0.7965 1.0521 1.570
## par3 0.48109 0.9167 1.1474 1.4030 1.925</code></pre>
</div>
<div id="reusing-fmcmc_kernel-objects" class="section level1">
<h1 class="hasAnchor">
<a href="#reusing-fmcmc_kernel-objects" class="anchor"></a>Reusing fmcmc_kernel objects</h1>
<p><code>fmcmc_kernel</code> objects are environments that are passed to the <code>MCMC</code> function. While the <code>MCMC</code> function only returns the <code>mcmc</code> class object (as defined in the <code>coda</code> package), users can exploit the fact that the kernel objects are environments to reuse them or inspect them once the <code>MCMC</code> function returns.</p>
<p>This could be particularly useful in the case of adaptive kernels as users can review the covariance structure (for example) or other components of the kernel.</p>
<p>To illustrate this, let’s re-do the MCMC chain of the previous example but using an adaptive kernel instead, in particular, Haario’s 2010 adaptive metropolis.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">khaario &lt;-<span class="st"> </span><span class="kw"><a href="../reference/kernel_adapt.html">kernel_adapt</a></span>(<span class="dt">freq =</span> <span class="dv">1</span>, <span class="dt">warmup =</span> <span class="dv">500</span>)</a></code></pre></div>
<p>This kernel object will be updated at every step (<code>freq = 1</code>) and adaptation will start from step 500 (<code>warmup = 500</code>). We can see that some of its components haven’t been initialized or have default starting values before the call of the <code>MCMC</code> function:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># Number of iterations (absolute count, starts in 0)</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">khaario<span class="op">$</span>abs_iter</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># Variance covariance matrix (is empty... for now)</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">khaario<span class="op">$</span>Sigma</a></code></pre></div>
<pre><code>## NULL</code></pre>
<p>Let’s see how it works:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">12</span>) </a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">out_harrio_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">  <span class="dt">initial   =</span> out,                       </a>
<a class="sourceLine" id="cb18-5" data-line-number="5">  <span class="dt">fun       =</span> lupost, </a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  <span class="dt">nsteps    =</span> <span class="dv">1000</span>,    <span class="co"># We will only run the chain for 100 steps                    </span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">  <span class="dt">kernel    =</span> khaario, <span class="co"># We passed the predefined kernel</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">  <span class="dt">thin      =</span> <span class="dv">1</span>,       <span class="co"># No thining here</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">  <span class="dt">nchains   =</span> 1L,      <span class="co"># A single chain</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10">  <span class="dt">multicore =</span> <span class="ot">FALSE</span>    <span class="co"># Running in serial</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11">  )</a></code></pre></div>
<p>Let’s inspect the output and mark when the adaptation starts:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/coda/man/traceplot.html">traceplot</a></span>(out_harrio_<span class="dv">1</span>[,<span class="dv">1</span>], <span class="dt">main =</span> <span class="st">"Traceplot of the first parameter"</span>)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">v =</span> <span class="dv">500</span>, <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/haario-first-run-plots-1.png" width="600" height="600"></p>
<p>If we look at the <code>khaario</code> kernel, the <code>fmcmc_kernel</code> object, we can see that things changed from the first time we ran it</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co"># Number of iterations (absolute count, the counts equal the number of steps)</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">khaario<span class="op">$</span>abs_iter</a></code></pre></div>
<pre><code>## [1] 1000</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co"># Variance covariance matrix (now is not empty)</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">(Sigma1 &lt;-<span class="st"> </span>khaario<span class="op">$</span>Sigma)</a></code></pre></div>
<pre><code>##              [,1]         [,2]         [,3]        [,4]         [,5]
## [1,]  0.030769025 -0.007959858  0.000105674 0.001215879  0.025767281
## [2,] -0.007959858  0.081535551 -0.032983224 0.005868047 -0.010501081
## [3,]  0.000105674 -0.032983224  0.073560617 0.013602060 -0.011829260
## [4,]  0.001215879  0.005868047  0.013602060 0.074296323  0.001624821
## [5,]  0.025767281 -0.010501081 -0.011829260 0.001624821  0.031309621</code></pre>
<p>If we re-run the chain, using as starting point the last step of the first run, we can also continue using the kernel object:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">out_harrio_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">  <span class="dt">initial   =</span> out_harrio_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">  <span class="dt">fun       =</span> lupost, </a>
<a class="sourceLine" id="cb24-4" data-line-number="4">  <span class="dt">nsteps    =</span> <span class="dv">2000</span>,    <span class="co"># We will only run the chain for 2000 steps now</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5">  <span class="dt">kernel    =</span> khaario, <span class="co"># Same as before, same kernel.</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6">  <span class="dt">thin      =</span> <span class="dv">1</span>,       </a>
<a class="sourceLine" id="cb24-7" data-line-number="7">  <span class="dt">nchains   =</span> 1L,      </a>
<a class="sourceLine" id="cb24-8" data-line-number="8">  <span class="dt">multicore =</span> <span class="ot">FALSE</span>    </a>
<a class="sourceLine" id="cb24-9" data-line-number="9">  )</a></code></pre></div>
<p>Let’s see again how does everything looks like:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/coda/man/traceplot.html">traceplot</a></span>(out_harrio_<span class="dv">2</span>[,<span class="dv">1</span>], <span class="dt">main =</span> <span class="st">"Traceplot of the first parameter"</span>)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">v =</span> <span class="dv">500</span>, <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/haario-second-run-plots-1.png" width="600" height="600"></p>
<p>As shown in the plot, since the warmup period already passed for the kernel object, the adaptation process is happening continuously so we don’t see a big break at step 500 as before. Let’s see now the counts and the covariance matrix and compare it with the previous one:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co"># Number of iterations (absolute count, the counts equal the number of steps)</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="co"># This will have 1000 (first run) + 2000 (second run) steps</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3">khaario<span class="op">$</span>abs_iter</a></code></pre></div>
<pre><code>## [1] 3000</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="co"># Variance covariance matrix (now is not empty)</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2">(Sigma2 &lt;-<span class="st"> </span>khaario<span class="op">$</span>Sigma)</a></code></pre></div>
<pre><code>##            [,1]         [,2]        [,3]         [,4]         [,5]
## [1,] 0.08889329  0.010677087  0.03792128  0.005396280  0.010543827
## [2,] 0.01067709  0.110626000 -0.01696425 -0.007246985 -0.016688348
## [3,] 0.03792128 -0.016964251  0.11818972  0.015875027 -0.017081078
## [4,] 0.00539628 -0.007246985  0.01587503  0.121572142  0.008640497
## [5,] 0.01054383 -0.016688348 -0.01708108  0.008640497  0.115435585</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="co"># How different these are?</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2">Sigma1 <span class="op">-</span><span class="st"> </span>Sigma2</a></code></pre></div>
<pre><code>##              [,1]         [,2]         [,3]         [,4]         [,5]
## [1,] -0.058124262 -0.018636944 -0.037815608 -0.004180402  0.015223454
## [2,] -0.018636944 -0.029090449 -0.016018973  0.013115032  0.006187267
## [3,] -0.037815608 -0.016018973 -0.044629102 -0.002272967  0.005251818
## [4,] -0.004180402  0.013115032 -0.002272967 -0.047275819 -0.007015676
## [5,]  0.015223454  0.006187267  0.005251818 -0.007015676 -0.084125964</code></pre>
<p>Things have changed since the last time we used the kernel, as expected. Kernel objects in the <code>fmcmc</code> package can also be used with multiple chains and in parallel. The <code>MCMC</code> function is smart enough to create independent copies of <code>fmcmc_kernel</code> objects when running multiple chains, and keep the original kernel objects up-to-date even when using multiple cores to run <code>MCMC</code>. For more technical details on how <code>fmcmc_kernel</code> objects work see the manual <code><a href="../reference/kernel_new.html">?fmcmc_kernel</a></code> or the vignette “User-defined kernels” included in the package <code><a href="../articles/user-defined-kernels.html">vignette("user-defined-kernels", package = "fmcmc")</a></code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#motivating-example">Motivating example</a></li>
      <li><a href="#reusing-fmcmc_kernel-objects">Reusing fmcmc_kernel objects</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by George Vega Yon, National
         Cancer Institute (NCI).</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

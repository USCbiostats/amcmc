<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow with fmcmc • fmcmc</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Workflow with fmcmc">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-108627422-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108627422-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fmcmc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/user-defined-kernels.html">User-defined kernels</a>
    </li>
    <li>
      <a href="../articles/workflow-with-fmcmc.html">Workflow with fmcmc</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USCbiostats/fmcmc">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Workflow with fmcmc</h1>
                        <h4 class="author">George G. Vega Yon</h4>
            
            <h4 class="date">April 19th, 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USCbiostats/fmcmc/blob/master/vignettes/workflow-with-fmcmc.Rmd"><code>vignettes/workflow-with-fmcmc.Rmd</code></a></small>
      <div class="hidden name"><code>workflow-with-fmcmc.Rmd</code></div>

    </div>

    
    
<p>We start by loading the dataset that the <code>mcmc</code> package includes. We will use the <code>logit</code> data set to obtain a posterior distribution of the model parameters using the <code>MCMC</code> function.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fmcmc)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(logit, <span class="dt">package =</span> <span class="st">"mcmc"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(y <span class="op">~</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">+</span><span class="st"> </span>x3 <span class="op">+</span><span class="st"> </span>x4, <span class="dt">data =</span> logit, <span class="dt">family =</span> binomial, <span class="dt">x =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">beta.init &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span>(out))</a></code></pre></div>
<p>To be able to use the Metropolis-Hastings MCMC algorithm the function should be (in principle) the log unnormalized posterior. The following block of code, which was extracted from the <code>mcmc</code> package vignette “MCMC Package Example” creates the function that we will be using</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">lupost_factory &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="cf">function</span>(beta) {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">    eta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(x <span class="op">%*%</span><span class="st"> </span>beta)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    logp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(eta <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, eta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(eta)), <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="st"> </span>eta)))</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    logq &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(eta <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(eta)), <span class="op">-</span><span class="st"> </span>eta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="st"> </span>eta)))</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    logl &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(logp[y <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(logq[y <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(logl <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(beta<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span><span class="dv">8</span>)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">lupost &lt;-<span class="st"> </span><span class="kw">lupost_factory</span>(out<span class="op">$</span>x, out<span class="op">$</span>y)</a></code></pre></div>
<p>Let’s give it a first try. In this case we will use the beta estimates from the estimated GLM model as a starting point for the algorithm, and we will ask it to sample 1e4 points from the posterior distribution (<code>nsteps</code>).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># to get reproducible results</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="dt">initial =</span> beta.init,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="dt">fun     =</span> lupost,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  <span class="dt">nsteps  =</span> <span class="fl">1e3</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">)</a></code></pre></div>
<p>Since the resulting object is of class <code>mcmc</code> (from the <code>coda</code> R package), we can use all the functions included in <code>coda</code> for model diagnostics:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(coda)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/post-estimation-1.png" width="600" height="600"></p>
<p>So this chain has very poor mixing, so let’s try again by using a smaller scale for the normal kernel proposal moving it from 1 (the default value) to .2:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># to get reproducible results</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="dt">initial =</span> beta.init,</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="dt">fun     =</span> lupost,</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="dt">nsteps  =</span> <span class="fl">1e3</span>,</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="dt">kernel  =</span> <span class="kw"><a href="../reference/kernels.html">kernel_normal</a></span>(<span class="dt">scale =</span> <span class="fl">.2</span>) </a>
<a class="sourceLine" id="cb5-8" data-line-number="8">)</a></code></pre></div>
<p>The <code>kernel_normal</code>, which is the default kernel in the <code>MCMC</code> function, returns an object of class <code>fmcmc_kernel</code>. In principle it consists on a list of two functions that are used by the <code>MCMC</code> routine: <code>proposal</code>, the proposal kernel function, and <code>logratio</code>, the function that returns the log of the Metropolis-Hastings ratio. We will talk more about <code>fmcmc_kernel</code> objects later. Now, let’s look at the first three variables of our model:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/unnamed-chunk-1-1.png" width="600" height="600"></p>
<p>Better. Now, ideally we should only be using observations from the stationary distribution. Let’s give it another try checking for convergence every 1,000 steps using the <code>convergence_geweke</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># to get reproducible results</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="dt">initial =</span> beta.init,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="dt">fun     =</span> lupost,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="dt">nsteps  =</span> <span class="fl">1e4</span>,</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="dt">kernel  =</span> <span class="kw"><a href="../reference/kernels.html">kernel_normal</a></span>(<span class="dt">scale =</span> <span class="fl">.2</span>),</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="dt">conv_checker =</span> <span class="kw"><a href="../reference/convergence-checker.html">convergence_geweke</a></span>(<span class="dv">200</span>)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">)</a></code></pre></div>
<pre><code>## Convergence has been reached with 200 steps (200 final count of samples).</code></pre>
<p>A bit better. As announced by <code>MCMC</code>, the chain has reach a stationary state. With this in hand, we can now rerun the algorithm such that we start from the last couple of step of the chain, this time, without convergence monitoring as it is no longer necessary.</p>
<p>We will increase the number of steps (sample size), use 2 chains using parallel computing, and add some thinning to reduce autocorrelation:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># Now we change the seed so we get a different stream of</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co"># pseudo random numbers</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">112</span>) </a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">out_final &lt;-<span class="st"> </span><span class="kw"><a href="../reference/MCMC.html">MCMC</a></span>(</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="dt">initial   =</span> out,                       <span class="co"># Automagically takes the last 2 points</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="dt">fun       =</span> lupost, </a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="dt">nsteps    =</span> <span class="fl">5e4</span>,                       <span class="co"># Increasing the sample size</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  <span class="dt">kernel    =</span> <span class="kw"><a href="../reference/kernels.html">kernel_normal</a></span>(<span class="dt">scale =</span> <span class="fl">.2</span>),</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  <span class="dt">thin      =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">  <span class="dt">nchains   =</span> 2L,                        <span class="co"># Running parallel chains</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="dt">multicore =</span> <span class="ot">TRUE</span>                       <span class="co"># in parallel.</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  )</a></code></pre></div>
<p>Observed that, instead of specifying what are the 2 starting points for each chain, we passed the <code>out</code> to the initial set of parameters. By default, if <code>initial</code> is of class <code>mcmc</code>, <code>MCMC</code> will take the last <code>nchains</code> points from the chain as starting point for the new sequence. If <code>initial</code> is of class <code>mcmc.list</code>, the number of chains in <code>initial</code> must match the <code>nchains</code> parameter. We now see that the output posterior distribution appears to be stationary</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out_final[, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<p><img src="workflow-with-fmcmc_files/figure-html/final-results-1.png" width="600" height="600"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(out_final[, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a></code></pre></div>
<pre><code>## 
## Iterations = 10:50000
## Thinning interval = 10 
## Number of chains = 2 
## Sample size per chain = 5000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##        Mean     SD Naive SE Time-series SE
## par1 0.6538 0.3037 0.003037       0.004982
## par2 0.8074 0.3730 0.003730       0.006752
## par3 1.1649 0.3644 0.003644       0.006688
## 
## 2. Quantiles for each variable:
## 
##         2.5%    25%    50%    75% 97.5%
## par1 0.08219 0.4435 0.6465 0.8529 1.273
## par2 0.10899 0.5489 0.7965 1.0521 1.570
## par3 0.48109 0.9167 1.1474 1.4030 1.925</code></pre>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by George Vega Yon, National
         Cancer Institute (NCI).</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
